import cv2
import numpy as np
from PIL import Image

def detect_hand(image_path):
    """Обнаружение руки на изображении"""
    img = cv2.imread(image_path)
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    
    # Простой детектор краев для поиска контуров, похожих на руку
    edges = cv2.Canny(gray, 50, 150)
    
    # Находим контуры
    contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    
    # Ищем контуры, которые могут быть рукой (по площади и форме)
    hand_contours = []
    for contour in contours:
        area = cv2.contourArea(contour)
        if 1000 < area < 10000:  # Фильтруем по размеру
            hand_contours.append(contour)
    
    return hand_contours, img

def add_beer_mug(image_path, output_path):
    """Добавляет кружку пива на изображение"""
    try:
        # Загружаем изображение
        img = cv2.imread(image_path)
        if img is None:
            return False
        
        # Загружаем шаблон кружки пива
        beer_mug = cv2.imread('templates/beer.png', -1)  # -1 для загрузки с альфа-каналом
        
        if beer_mug is None:
            # Создаем простую кружку пива программно, если файла нет
            beer_mug = create_simple_beer_mug()
        
        # Определяем размеры
        img_height, img_width = img.shape[:2]
        beer_height, beer_width = beer_mug.shape[:2]
        
        # Масштабируем кружку в зависимости от размера изображения
        scale = min(img_width, img_height) * 0.2 / beer_width
        new_width = int(beer_width * scale)
        new_height = int(beer_height * scale)
        beer_mug = cv2.resize(beer_mug, (new_width, new_height))
        
        # Позиционируем кружку в правом нижнем углу
        x_offset = img_width - new_width - 20
        y_offset = img_height - new_height - 20
        
        # Накладываем кружку с учетом прозрачности
        for y in range(new_height):
            for x in range(new_width):
                if y + y_offset < img_height and x + x_offset < img_width:
                    alpha = beer_mug[y, x, 3] / 255.0
                    for c in range(3):
                        img[y + y_offset, x + x_offset, c] = (
                            alpha * beer_mug[y, x, c] + 
                            (1 - alpha) * img[y + y_offset, x + x_offset, c]
                        )
        
        # Сохраняем результат
        cv2.imwrite(output_path, img)
        return True
        
    except Exception as e:
        print(f"Error in add_beer_mug: {e}")
        return False

def create_simple_beer_mug():
    """Создает простую кружку пива программно"""
    size = 200
    beer_mug = np.zeros((size, size, 4), dtype=np.uint8)
    
    # Рисуем кружку (простой прямоугольник с ручкой)
    # Основная часть кружки
    cv2.rectangle(beer_mug, (50, 30), (150, 170), (200, 150, 50, 255), -1)
    
    # Пена
    cv2.rectangle(beer_mug, (50, 20), (150, 40), (255, 255, 255, 255), -1)
    
    # Ручка
    cv2.ellipse(beer_mug, (160, 100), (20, 40), 0, 0, 360, (150, 100, 50, 255), -1)
    
    return beer_mug
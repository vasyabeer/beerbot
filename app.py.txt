import os
import logging
import tempfile
from flask import Flask, request
import cv2
import numpy as np
from PIL import Image

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
WEBHOOK_URL = os.environ.get('WEBHOOK_URL')
PORT = int(os.environ.get('PORT', 5000))

app = Flask(__name__)

def create_simple_beer_mug():
    """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç—É—é –∫—Ä—É–∂–∫—É –ø–∏–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ"""
    size = 200
    beer_mug = np.zeros((size, size, 4), dtype=np.uint8)
    
    # –†–∏—Å—É–µ–º –∫—Ä—É–∂–∫—É
    cv2.rectangle(beer_mug, (50, 30), (150, 170), (200, 150, 50, 255), -1)  # –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å
    cv2.rectangle(beer_mug, (50, 20), (150, 40), (255, 255, 255, 255), -1)  # –ü–µ–Ω–∞
    cv2.ellipse(beer_mug, (160, 100), (20, 40), 0, 0, 360, (150, 100, 50, 255), -1)  # –†—É—á–∫–∞
    
    return beer_mug

def add_beer_mug(input_path, output_path):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∫—Ä—É–∂–∫—É –ø–∏–≤–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = cv2.imread(input_path)
        if img is None:
            return False
        
        # –°–æ–∑–¥–∞–µ–º –∫—Ä—É–∂–∫—É –ø–∏–≤–∞
        beer_mug = create_simple_beer_mug()
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
        img_height, img_width = img.shape[:2]
        beer_height, beer_width = beer_mug.shape[:2]
        
        # –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –∫—Ä—É–∂–∫—É
        scale = min(img_width, img_height) * 0.2 / beer_width
        new_width = int(beer_width * scale)
        new_height = int(beer_height * scale)
        beer_mug = cv2.resize(beer_mug, (new_width, new_height))
        
        # –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫—Ä—É–∂–∫—É
        x_offset = img_width - new_width - 20
        y_offset = img_height - new_height - 20
        
        # –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ–º –∫—Ä—É–∂–∫—É
        for y in range(new_height):
            for x in range(new_width):
                if y + y_offset < img_height and x + x_offset < img_width:
                    alpha = beer_mug[y, x, 3] / 255.0
                    for c in range(3):
                        img[y + y_offset, x + x_offset, c] = (
                            alpha * beer_mug[y, x, c] + 
                            (1 - alpha) * img[y + y_offset, x + x_offset, c]
                        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        cv2.imwrite(output_path, img)
        return True
        
    except Exception as e:
        logger.error(f"Error processing image: {e}")
        return False

@app.route('/')
def index():
    return "Beer Bot is running! üçª"

@app.route('/webhook', methods=['POST'])
def webhook():
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–∞ –æ—Ç Telegram"""
    try:
        from telegram import Update, Bot
        from telegram.ext import Application, MessageHandler, filters, CallbackContext
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
        bot = Bot(token=TOKEN)
        update = Update.de_json(request.get_json(), bot)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        if update.message and update.message.photo:
            process_photo(bot, update.message)
        
        return "OK"
    except Exception as e:
        logger.error(f"Webhook error: {e}")
        return "ERROR", 500

def process_photo(bot, message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ"""
    try:
        chat_id = message.chat.id
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
        bot.send_message(chat_id, "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ... üçª")
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ (–±–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ)
        photo_file = message.photo[-1].get_file()
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as input_file:
            input_path = input_file.name
        
        with tempfile.NamedTemporaryFile(suffix='.jpg', delete=False) as output_file:
            output_path = output_file.name
        
        try:
            # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
            photo_file.download(input_path)
            
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            success = add_beer_mug(input_path, output_path)
            
            if success:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
                with open(output_path, 'rb') as photo:
                    bot.send_photo(
                        chat_id=chat_id,
                        photo=photo,
                        caption="–í–∞—à–µ —Ñ–æ—Ç–æ —Å –∫—Ä—É–∂–∫–æ–π –ø–∏–≤–∞! üçª"
                    )
            else:
                bot.send_message(chat_id, "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ üòî")
                
        finally:
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            if os.path.exists(input_path):
                os.unlink(input_path)
            if os.path.exists(output_path):
                os.unlink(output_path)
                
    except Exception as e:
        logger.error(f"Error processing photo: {e}")
        bot.send_message(message.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ üòî")

@app.route('/set_webhook', methods=['GET'])
def set_webhook():
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞"""
    try:
        if not TOKEN or not WEBHOOK_URL:
            return "TOKEN or WEBHOOK_URL not set", 400
            
        from telegram import Bot
        bot = Bot(token=TOKEN)
        webhook_url = f"{WEBHOOK_URL}/webhook"
        result = bot.set_webhook(webhook_url)
        
        return f"Webhook set to {webhook_url}: {result}"
    except Exception as e:
        return f"Error setting webhook: {e}", 500

@app.route('/remove_webhook', methods=['GET'])
def remove_webhook():
    """–£–¥–∞–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞"""
    try:
        from telegram import Bot
        bot = Bot(token=TOKEN)
        result = bot.delete_webhook()
        return f"Webhook removed: {result}"
    except Exception as e:
        return f"Error removing webhook: {e}", 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT)